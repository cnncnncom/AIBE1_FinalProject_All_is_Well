<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${book.title} + ' - 북적북적'">책 상세 정보</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="relative flex min-h-screen flex-col bg-white" style="font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif;">
<div class="flex flex-col grow layout-container">
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="flex flex-1 justify-center px-6 md:px-40 py-6">
        <div class="w-full max-w-[960px] flex flex-col">

            <section class="px-4 pt-4 text-center">
                <img th:src="${book.coverImageUrl}" alt="Book Cover" class="w-full max-w-xs mx-auto mb-4 rounded-lg" />
                <h1 class="text-[22px] font-bold text-[#111418] pb-2" th:text="${book.title}">The Great Gatsby</h1>
                <p class="text-base text-[#111418] pb-2" th:text="${book.author} + ' | ' + ${book.publisher} + ' | ' + ${book.publicationYear}"></p>
            </section>

            <section class="px-4 pt-6">
                <h2 class="text-lg font-bold text-[#111418] pb-2">판매자 정보</h2>
                <div class="flex items-center gap-4 bg-white py-2">
                    <div class="size-14 aspect-square bg-center bg-cover rounded-full"
                         th:style="'background-image: url(' + ${book.sellerProfileImageUrl} + ')'">
                    </div>
                    <div>
                        <p class="text-base font-medium text-[#111418] line-clamp-1"
                           th:text="${book.sellerNickname}">판매자 닉네임</p>
                    </div>
                </div>
            </section>

            <section class="px-4 pt-6">
                <div class="flex items-center gap-4 py-2">
                    <div class="shrink-0 size-12 flex items-center justify-center rounded-lg bg-[#f0f2f5]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M224,48H160a40,40,0,0,0-32,16A40,40,0,0,0,96,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H96a24,24,0,0,1,24,24,8,8,0,0,0,16,0,24,24,0,0,1,24-24h64a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM96,192H32V64H96a24,24,0,0,1,24,24V200A39.81,39.81,0,0,0,96,192Zm128,0H160a39.81,39.81,0,0,0-24,8V88a24,24,0,0,1,24-24h64Z" />
                        </svg>
                    </div>
                    <p class="text-base text-[#111418]" th:text="${book.detailedCondition}">This book is in excellent condition...</p>
                </div>
            </section>

            <section class="px-4 pt-8">
                <div class="p-6 rounded-lg bg-gray-50 border space-y-6">
                    <div>
                        <h3 class="text-lg font-bold text-[#111418] pb-2 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M224,48H160a40,40,0,0,0-32,16A40,40,0,0,0,96,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H96a24,24,0,0,1,24,24,8,8,0,0,0,16,0,24,24,0,0,1,24-24h64a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM96,192H32V64H96a24,24,0,0,1,24,24V200A39.81,39.81,0,0,0,96,192Zm128,0H160a39.81,39.81,0,0,0-24,8V88a24,24,0,0,1,24-24h64Z"></path></svg>
                            AI가 요약한 책 정보
                        </h3>
                        <p class="text-base text-gray-700 leading-relaxed" th:text="${book.summary}">
                            AI가 생성한 책 요약이 여기에 표시됩니다.
                        </p>
                    </div>

                    <hr/>

                    <div>
                        <h3 class="text-lg font-bold text-[#111418] pb-2 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-32-88a12,12,0,1,1,12,12A12,12,0,0,1,96,128Zm64,0a12,12,0,1,1,12,12A12,12,0,0,1,160,128Zm-21.84,41.42a8,8,0,0,1-11.32,1.13,47.81,47.81,0,0,0-53.68,0,8,8,0,0,1-12.45-10.1A64,64,0,0,1,128,136a63.81,63.81,0,0,1,49,22.32A8,8,0,0,1,169.84,169.42Z"></path></svg>
                            아이유의 리뷰
                        </h3>
                        <div class="text-base text-gray-700 leading-relaxed" th:utext="${#strings.replace(book.personaReview, '\n', '<br/>')}">
                            AI가 생성한 페르소나 리뷰가 여기에 표시됩니다.
                        </div>
                    </div>
                </div>
            </section>

            <section class="px-4 pt-6 pb-4">
                <h2 class="text-lg font-bold text-[#111418] pb-2">최종 가격</h2>
                <div class="flex justify-between items-center bg-white min-h-14">
                    <p class="text-xl font-bold text-[#111418] truncate" th:text="${#numbers.formatInteger(book.sellingPrice, 3, 'COMMA')} + '원'"></p>
                    <div class="flex items-center gap-2">
                        <div class="size-3 rounded-full bg-[#07883b]"></div>
                        <span class="text-sm font-medium text-[#07883b]"
                              th:text="${book.status == 'FOR_SALE' ? '판매중' : (book.status == 'SOLD' || book.status == '판매 완료' ? '판매 완료' : book.status)}">
                            판매중
                        </span>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <footer class="sticky bottom-0 border-t border-gray-200 bg-white">
        <div class="flex gap-3 p-3 max-w-[960px] mx-auto">
            <button id="wishlist-button" class="min-w-[84px] h-12 px-4 bg-[#f0f2f5] text-[#111418] font-bold rounded-lg"
                    th:if="${book.sellerId != userId}">찜하기</button>
            <button id="delete-button" class="min-w-[84px] h-12 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500"
                    th:if="${book.sellerId == userId}">삭제</button>
            <button id="purchase-button" class="flex-1 min-w-[84px] h-12 px-4 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-700">채팅하기 / 구매 요청</button>
        </div>
    </footer>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const bookId = /*[[${book.id}]]*/ 'default';

    const wishlistBtn = document.getElementById('wishlist-button');
    if (wishlistBtn) wishlistBtn.addEventListener('click', function() {
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/api/wishlist?usedBookId=${bookId}`, {
            method: 'POST',
            headers: { [csrfHeader]: csrfToken }
        })
            .then(async response => {
                if (response.ok) {
                    alert('위시리스트에 추가되었습니다.');
                } else if (response.status === 401) {
                    alert('로그인이 필요합니다.');
                } else if (response.status === 403) {
                    alert('보안 토큰이 유효하지 않습니다.');
                } else if (response.status === 409) {
                    alert('이미 찜한 책입니다.');
                } else {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.message || '찜하기 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                alert(error.message);
            });
    });

    const deleteBtn = document.getElementById('delete-button');
    if (deleteBtn) deleteBtn.addEventListener('click', function() {
        if (!confirm('정말 삭제하시겠습니까?')) return;
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        fetch(`/api/used-books/${bookId}`, {
            method: 'DELETE',
            headers: { [header]: token }
        }).then(async res => {
            if (res.ok) {
                alert('삭제되었습니다.');
                location.href = '/profile/sales';
            } else if (res.status === 401) {
                alert('로그인이 필요합니다.');
            } else if (res.status === 403) {
                alert('삭제 권한이 없습니다.');
            } else {
                const data = await res.json().catch(() => ({}));
                alert(data.message || '삭제 중 오류가 발생했습니다.');
            }
        }).catch(err => alert(err.message));
    });

    document.getElementById('purchase-button').addEventListener('click', function() {
        if (!confirm('정말로 이 책을 구매하시겠습니까?')) {
            return;
        }

        fetch(`/api/used-books/${bookId}/purchase`, {
            method: 'POST',
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('구매 처리 중 문제가 발생했습니다.');
            })
            .then(message => {
                alert(message);
                window.location.reload();
            })
            .catch(error => {
                alert(error.message);
            });
    });
    /*]]>*/
</script>
</body>
</html>