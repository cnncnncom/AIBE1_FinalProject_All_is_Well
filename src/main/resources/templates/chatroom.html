<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>채팅방 - 북적북적</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="relative flex min-h-screen flex-col bg-white" style="font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif;">
<div class="flex flex-col grow layout-container">
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="flex-1 flex justify-center px-6 md:px-40 py-6">
        <div class="w-full max-w-[960px] flex flex-col gap-6">
            <div class="border rounded-lg px-4 py-3 bg-gray-50 flex justify-between items-center">
                <div>
                    <p class="text-lg font-bold" th:text="${partnerNickname}">상대방 닉네임</p>
                    <p class="text-sm text-gray-500" th:text="'책 제목: ' + ${bookTitle}">책 제목</p>
                </div>
                <div class="flex gap-2 items-center">
                    <a th:href="${bookUrl}" class="text-sm text-blue-600 hover:underline">책 보러가기</a>
                    <button class="px-2 py-1 text-xs border rounded" id="completeBtn">거래완료</button>
                    <button class="px-2 py-1 text-xs border rounded" id="closeBtn">대화종료</button>
                </div>
            </div>

            <div id="messageArea" class="flex flex-col gap-2 p-4 border rounded-lg h-[400px] overflow-y-auto bg-white shadow-inner">
            </div>

            <div class="flex gap-2">
                <input id="messageInput" type="text" placeholder="메시지를 입력하세요" class="w-full rounded-lg border border-gray-300 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button id="sendButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">전송</button>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script th:inline="javascript">
    // Thymeleaf에서 받은 변수들을 JS 변수로 초기화
    const channelId = /*[[${channelId}]]*/ 0;
    const currentUserId = /*[[${userId}]]*/ 0;
    let lastMessageId = 0;

    // SockJS와 STOMP 클라이언트 객체 초기화
    const socket = new SockJS("/ws-chat"); // WebSocketConfig에 설정된 엔드포인트
    const stompClient = Stomp.over(socket);

    // 에러 콜백 함수 정의
    const onError = (error) => {
        console.error('STOMP Error:', error);
    };

    // 연결 콜백 함수 정의
    const onConnected = () => {
        console.log('STOMP Connected!');
        // 특정 채널을 구독하여 서버로부터 메시지를 받음
        stompClient.subscribe(`/topic/chat/${channelId}`, (messageOutput) => {
            showMessage(JSON.parse(messageOutput.body));
        });

        // 채팅방에 입장하면 이전 대화 기록을 불러옴
        fetchPreviousMessages();
    };

    // STOMP 클라이언트 연결 실행
    stompClient.connect({}, onConnected, onError);


    // 메시지 전송 함수
    const sendMessage = () => {
        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();

        if (content && stompClient) {
            const chatMessage = {
                channelId: channelId,
                senderId: currentUserId,
                content: content
            };
            // @MessageMapping 경로로 메시지를 전송
            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
            messageInput.value = ""; // 입력창 비우기
        }
    };

    // 화면에 메시지를 그리는 함수
    const showMessage = (message) => {
        const messageArea = document.getElementById("messageArea");
        const msgEl = document.createElement("div");
        const textEl = document.createElement("span");

        // 내가 보낸 메시지인지 확인
        const isMine = Number(message.senderId) === Number(currentUserId);

        // 메시지 스타일 설정
        msgEl.className = `flex items-center max-w-[70%] px-4 py-2 rounded-lg text-sm shadow ${isMine ? 'bg-blue-100 self-end' : 'bg-gray-100 self-start'}`;
        msgEl.dataset.messageId = message.messageId;
        textEl.textContent = message.content;
        msgEl.appendChild(textEl);

        if (isMine) {
            const delBtn = document.createElement('button');
            delBtn.textContent = '삭제';
            delBtn.className = 'ml-2 text-xs text-red-500';
            delBtn.addEventListener('click', () => deleteMessage(message.messageId, msgEl));
            msgEl.appendChild(delBtn);
        }

        messageArea.appendChild(msgEl);
        messageArea.scrollTop = messageArea.scrollHeight; // 항상 최신 메시지가 보이도록 스크롤
    };

    // 이전 대화 내역을 불러오는 함수
    const fetchPreviousMessages = () => {
        fetch(`/api/chat/channel/${channelId}/messages`)
            .then(response => response.json())
            .then(messages => {
                messages.forEach(msg => {
                    showMessage(msg);
                    if (msg.messageId && msg.messageId > lastMessageId) {
                        lastMessageId = msg.messageId;
                    }
                });
            });
    };

    const pollNewMessages = () => {
        fetch(`/api/chat/channel/${channelId}/messages`)
            .then(response => response.json())
            .then(messages => {
                messages.forEach(msg => {
                    if (msg.messageId && msg.messageId > lastMessageId) {
                        showMessage(msg);
                        lastMessageId = msg.messageId;
                    }
                });
            });
    };

    const deleteMessage = (messageId, element) => {
        fetch(`/api/chat/message/${messageId}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    element.remove();
                } else {
                    alert('삭제 실패');
                }
            });
    };
    setInterval(pollNewMessages, 3000); // 3초마다 새 메시지 확인

    // '전송' 버튼 클릭 이벤트 리스너
    document.getElementById("sendButton").addEventListener("click", sendMessage);

    // Enter 키 입력 이벤트 리스너
    document.getElementById("messageInput").addEventListener("keypress", (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

</script>

</body>
</html>